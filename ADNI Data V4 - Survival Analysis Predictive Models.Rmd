---
title: "ADNI Data V2 - Survival Analysis Predictive Models"
output: html_document
date: "2023-03-29"
---

# ADNI Data V4 - Survival Analysis Predictive Models - same as version 3 except this time I am doing it for all the different recipes

## Install and load the relevant packages

```{r}

# install.packages("caret")
library(caret)

# install.packages("ranger")
library(ranger)

# install.packages("tidymodels")
library(tidymodels)

# install.packages("tidyverse")
library(tidyverse)

# install.packages("glmnet")
library(glmnet)

# install.packages("modeldatatoo")
library(modeldatatoo)

# install.packages("aorsf")
library(aorsf)

# install.packages("censored")
library(censored)

# install.packages("survival")
library(survival)

# install.packages("doParallel")
library(doParallel)

library(pROC) #for AUC calculation
# Install and load necessary packages
# install.packages("tidymodels")
library(tidymodels)

# install.packages("survival")
library(survival)

# install.packages("doParallel")
library(doParallel)

# Set up parallel processing
registerDoParallel()

```

Import dataset, Pre-process & set up cross validation

```{r}

# Import preprocessed data 
surv_df <- read.csv("preprocessed_data.csv") 
View(surv_df)

# Remove rows with zero survival times
surv_df <- surv_df %>% filter(VISCODE > 0)

# Check event encoding
# table(surv_df$event)

# Create survival object
surv_df1 <- surv_df %>% 
  mutate(diagnosis_surv = Surv(VISCODE, event == "1")) %>%
  select(diagnosis_surv, everything())
# View(surv_df1)

# Define resampling scheme: repeated k-fold cross-validation
set.seed(403)
repeated_folds <- vfold_cv(surv_df1, v = 5, repeats = 3) # 5-fold cross-validatio

# colnames(surv_df1)
```

Define all the Recipies

```{r}

# --------------------------------------------------
# # Recipe for preprocessing the data
# surv_recipe <- recipe(diagnosis_surv ~ AGE + APOE4, data = surv_df1)
# --------------------------------------------------

# Different feature combos (recipes) - INDEx for myself
# recipe_1 = Family History 
# recipe_2 = Family History + APOE4  
# recipe_3 = Family History + APOE4 + Age
# recipe_4 = Family History + APOE4 + Age + Sex 
# recipe_5 = Family History + APOE4 + Age + Sex + MMSE 
# recipe_6 = Family History + APOE4 + Age + Sex + MMSE + mPACCtrailsB 
# recipe_7 = Family History + APOE4 + Age + Sex + MMSE + mPACCtrailsB + PTEDUCAT
# recipe_8 = APOE4 + Age + Sex + MMSE + mPACCtrailsB + PTEDUCAT
# recipe_9 = APOE4 + Age + Sex + MMSE + mPACCtrailsB 
# recipe_10 = APOE4 + Age + Sex + MMSE 
# recipe_11 = APOE4 + Age + Sex 
# recipe_12 = APOE4 + Age 
# recipe_13 = APOE4

# List of different recipes based on the specified feature combinations
recipes_list <- list(
# recipe_1 = recipe(diagnosis_surv ~ fam_hist_dad_dem + fam_hist_dad_ad + fam_hist_mum_dem + fam_hist_mum_ad, data = surv_df1),
# recipe_2 = recipe(diagnosis_surv ~ fam_hist_dad_dem + fam_hist_dad_ad + fam_hist_mum_dem + fam_hist_mum_ad + APOE4, data = surv_df1),
# recipe_3 = recipe(diagnosis_surv ~ fam_hist_dad_dem + fam_hist_dad_ad + fam_hist_mum_dem + fam_hist_mum_ad + APOE4 + AGE, data = surv_df1),
# recipe_4 = recipe(diagnosis_surv ~ fam_hist_dad_dem + fam_hist_dad_ad + fam_hist_mum_dem + fam_hist_mum_ad + APOE4 + AGE + PTGENDER, data = surv_df1),
# recipe_5 = recipe(diagnosis_surv ~ fam_hist_dad_dem + fam_hist_dad_ad + fam_hist_mum_dem + fam_hist_mum_ad + APOE4 + AGE + PTGENDER + MMSE, data = surv_df1),
# recipe_6 = recipe(diagnosis_surv ~ fam_hist_dad_dem + fam_hist_dad_ad + fam_hist_mum_dem + fam_hist_mum_ad + APOE4 + AGE + PTGENDER + MMSE + mPACCtrailsB, data = surv_df1),
# recipe_7 = recipe(diagnosis_surv ~ fam_hist_dad_dem + fam_hist_dad_ad + fam_hist_mum_dem + fam_hist_mum_ad + APOE4 + AGE + PTGENDER + MMSE + mPACCtrailsB + PTEDUCAT, data = surv_df1),
# recipe_8 = recipe(diagnosis_surv ~ APOE4 + AGE + PTGENDER + MMSE + mPACCtrailsB + PTEDUCAT, data = surv_df1),
# recipe_9 = recipe(diagnosis_surv ~ APOE4 + AGE + PTGENDER + MMSE + mPACCtrailsB, data = surv_df1),
recipe_10 = recipe(diagnosis_surv ~ APOE4 + AGE + PTGENDER + MMSE, data = surv_df1),
recipe_11 = recipe(diagnosis_surv ~ APOE4 + AGE + PTGENDER, data = surv_df1),
recipe_12 = recipe(diagnosis_surv ~ APOE4 + AGE, data = surv_df1)
# recipe_13 = recipe(diagnosis_surv ~ APOE4, data = surv_df1)
)


# Initialize list to store results for each recipe and model
results_list <- list()

# Iterate through recipes and run models for each
for (i in seq_along(recipes_list)) {
  # Select the current recipe
  current_recipe <- recipes_list[[i]]
  
  # Define models: Weibull, Cox, Random Forest
  # Weibull Model
  survreg_wflow <- workflow() %>% 
    add_recipe(current_recipe) %>% 
    add_model(survival_reg() %>% set_engine("survival") %>% set_mode("censored regression"))
  
  # Cox Proportional Hazards Model
  coxnet_wflow <- workflow() %>%
    add_recipe(current_recipe) %>%
    add_model(proportional_hazards(penalty = tune()) %>% set_engine("glmnet") %>% set_mode("censored regression"))

  # Random Forest Model
  oblique_wflow <- workflow() %>%
    add_recipe(current_recipe) %>%
    add_model(rand_forest(mtry = tune(), min_n = tune()) %>% set_engine("aorsf") %>% set_mode("censored regression"))
  
  # Cross-validation resampling (for all models)
  set.seed(1)
  survreg_res <- fit_resamples(survreg_wflow, resamples = repeated_folds, metrics = survival_metrics, eval_time = evaluation_time_points, control = control_resamples(save_pred = TRUE))
  coxnet_res <- tune_grid(coxnet_wflow, resamples = repeated_folds, grid = 10, metrics = survival_metrics, eval_time = evaluation_time_points, control = control_grid(save_pred = TRUE))
  oblique_res <- tune_grid(oblique_wflow, resamples = repeated_folds, grid = 10, metrics = survival_metrics, eval_time = evaluation_time_points, control = control_grid(save_pred = TRUE))
  
  # Store the results for each model
  results_list[[paste0("Recipe_", i, "_Weibull")]] <- survreg_res
  results_list[[paste0("Recipe_", i, "_Cox")]] <- coxnet_res
  results_list[[paste0("Recipe_", i, "_RandomForest")]] <- oblique_res
}

# Access results using results_list[['Recipe_1_Weibull']], etc.
# Function to extract and prepare metrics for plotting
prepare_plot_data <- function(result, model_name, recipe_name) {
  collect_metrics(result) %>%
    mutate(model = model_name, recipe = recipe_name)
}

# Initialize an empty data frame to store all metrics
all_metrics <- data.frame()

# Loop through results and extract metrics for each model and recipe
for (name in names(results_list)) {
  model_name <- str_extract(name, "Weibull|Cox|RandomForest")
  recipe_name <- str_extract(name, "Recipe_\\d+")
  
  metrics_data <- prepare_plot_data(results_list[[name]], model_name, recipe_name)
  all_metrics <- bind_rows(all_metrics, metrics_data)
}

# Plot Brier score and ROC AUC for all models and recipes
ggplot(all_metrics, aes(x = recipe, y = mean, fill = model)) +
  geom_boxplot() +
  facet_wrap(~.metric, scales = "free_y") +
  labs(title = "Model Comparison Across Recipes", x = "Recipe", y = "Metric Value") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
