---
title: "regression temp"
author: "Uditi Shah"
date: '2024-10-29'
output: html_document
---

---
title: "UKBB Regression Analysis"
author: "Uditi Shah"
date: '2024-08-13'
output: html_document
---

# UKBB Regression Analysis

### Required Libraries and Dataset Loading

```{r}
# Install and load required packages
if(!require(pbapply)) install.packages("pbapply")
if(!require(ggplot2)) install.packages("ggplot2")
if(!require(GGally)) install.packages("GGally")
if(!require(dplyr)) install.packages("dplyr")
if(!require(readr)) install.packages("readr")

library(pbapply)
library(ggplot2)
library(GGally)
library(dplyr)
library(readr)

# Load dataset
geno_covar <- readRDS("ukb_adni_genotypes_58_snps_v2.RDS")

```

```{r}
# Source external regression function file
source('regression.R')

# Function to calculate and plot results
run_analysis <- function(model_name, y_pred_column, merged_data, plot_title, x_label, y_label) {
    # Compute summary statistics
    result <- computeSumStats(yp_dat = merged_data %>% pull(!!y_pred_column), 
                              merged_data %>% select(-!!.y_pred_column), 
                              is_binary = F)
    result_true_labels <- computeSumStats(yp_dat = merged_data %>% pull(conv), 
                                          merged_data %>% select(-!!.y_pred_column), 
                                          is_binary = T)
    
    # Data frame for plot
    df <- data.frame(
        snp_effect_size = -log10(result_true_labels$P),
        model_predictions = -log10(result$P)
    )
    
    # Calculate and print correlation
    correlation_value <- cor(df$snp_effect_size, df$model_predictions)
    print(paste("Correlation: ", round(correlation_value, 3)))

    # Create the plot
    p <- ggplot(df, aes(x = snp_effect_size, y = model_predictions)) +
        geom_point(color = 'blue', size = 2) +
        labs(
            title = plot_title,
            x = x_label,
            y = y_label
        ) +
        theme_minimal() +
        theme(
            plot.title = element_text(hjust = 0.5),
            axis.text = element_text(size = 12),
            axis.title = element_text(size = 14)
        ) +
        annotate("text", x = max(df$snp_effect_size) * 0.7, 
                 y = max(df$model_predictions) * 0.9, 
                 label = paste("Correlation: ", round(correlation_value, 3)), 
                 color = "black", size = 5)
    
    # Display the plot
    print(p)
}

# Plot function for filtered data
plot_filtered <- function(result_true_labels, result, plot_title, x_label, y_label) {
    I <- which(result_true_labels$P < 1e-7)
    df_filtered <- data.frame(
        snp_effect_size_filtered = -log10(result_true_labels$P[-I]),
        model_predictions_filtered = -log10(result$P[-I])
    )
    
    plot <- ggplot(df_filtered, aes(x = snp_effect_size_filtered, y = model_predictions_filtered)) +
        geom_point(color = 'red', size = 2) +
        labs(
            title = plot_title,
            x = x_label,
            y = y_label
        ) +
        theme_minimal() +
        theme(
            plot.title = element_text(hjust = 0.5),
            axis.text = element_text(size = 12),
            axis.title = element_text(size = 14)
        )
    print(plot)
}


```

```{r}

# Run the model and merge data
model_name <- 'D_xgb'
preds_ukbb <- predict(fit_models[[model_name]], new_data = UKBB_subset, type = "prob") %>%
    bind_cols(predict(fit_models[[model_name]], new_data = UKBB_subset)) %>%
    bind_cols(UKBB_subset)
merged_geno_df <- preds_ukbb %>% 
    inner_join(geno_covar %>% select(-conv, -AGE, -SEX, -FH, -APOE4), by = c('ID' = 'FID'))

# Run analysis and plot
run_analysis(
    model_name = model_name,
    y_pred_column = '.pred_No AD',
    merged_data = merged_geno_df,
    plot_title = "Demographics - XGBoost Model Predictions",
    x_label = "SNP Effect Size (Coefficient of Regression Actual Labels)",
    y_label = "Demographics (Predictions from XGB Model)"
)

# Plot filtered results
plot_filtered(result_true_labels, result, 
              plot_title = "Filtered Demographics - XGBoost Model Predictions",
              x_label = "SNP Effect Size (Filtered)", 
              y_label = "Predictions (Filtered)")

```

```{r}
model_name <- 'Fh_glm'
preds_ukbb <- predict(fit_models[[model_name]], new_data = UKBB_subset, type = "prob") %>%
    bind_cols(predict(fit_models[[model_name]], new_data = UKBB_subset)) %>%
    bind_cols(UKBB_subset)
merged_geno_df <- preds_ukbb %>% 
    inner_join(geno_covar %>% select(-conv, -AGE, -SEX, -FH, -APOE4), by = c('ID' = 'FID'))

run_analysis(
    model_name = model_name,
    y_pred_column = '.pred_No AD',
    merged_data = merged_geno_df,
    plot_title = "Family History - Logistic Regression Model",
    x_label = "SNP Effect Size (Coefficient of Regression Actual Labels)",
    y_label = "Family History Predictions"
)

plot_filtered(result_true_labels, result, 
              plot_title = "Filtered Family History - Logistic Regression Model",
              x_label = "SNP Effect Size (Filtered)", 
              y_label = "Predictions (Filtered)")

```

```{r}

```
