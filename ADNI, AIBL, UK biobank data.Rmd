---
title: "ADNI, AIBL, UK biobank Data - Descriptive Analysis"
author: "Uditi Shah"
date: '2024-08-13'
output: html_document
---

```{r}

# Install and load the tidyverse package, which is a collection of packages for data manipulation and visualization.
# install.packages("tidyverse")
library(tidyverse)

# readr: For reading CSV files
# dplyr: For data manipulation
# ggplot2:For plots and graphs
# tidyr: For tidying and reshaping data into a tidy format.
# purrr: For functional programming and working with lists and vectors.
# tibble: For creating and working with modern data frames.
# stringr: For string manipulation and text processing.
# forcats: For working with categorical data and factors.
# lubridate: For working with dates and times.
# magrittr: For creating expressive pipelines using the pipe operator %>%.
# rlang: For advanced manipulation and programming with R expressions.

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{ata <- read.csv("df_comb_ml.csv")}
# see 
```

```{r}

```

```{the whole data_set}
View(data)
```

```{r}

# Display the first 5 lines
head(data, 5)
```

```{r}
# dimensions
dim(data)
# 57066 rows and 15 columns
```

```{r}
# all the possible unique values that exist for each column/variable
length(unique(data$ID))
# this means that there are 57066 individuals in our data set

# filter is for rows
# select is for columns
# this can show us if there are NA = missing data, none = or unknown = which mean diff things
# table (ColumnName)
```

```{r}
# column/variable names
names(data)

# Attached is a set of data from ADNI, AIBL and UK Biobank
# ID    - Sample.id
# AGE    - Age in years
# SEX - is female (?)
# EDU   - years of education, bit different across cohorts
# FH  - Parental history of AD
# APOE4  - # of copies of APOE4 (0,1,2)
# DX - Diagnosis (baseline?)
# dataset - AIBL/ADNI/UKB
# conv - Do they Convert to AD or not
# AGE.bl - What is their age at baseline
# event_time - When do they convert to AD or leave the study
# APOE4_e4e4 - Do they have 2 copies of APOE4?
# FH_na - Is their family history missing?
# conv_fh - Do they have a history of AD or not (FH!=0)
```

```{r}


# Install and load the naniar package, which provides functions for exploring missing data patterns.
# install.packages("naniar")
library(naniar)

# View all the rows with dataset = ADNI 
ADNI <- data[data$dataset == "ADNI", ]
View(ADNI)

gg_miss_var(ADNI) + ggtitle("Missing Values in Each Column of ADNI Dataset")
vis_miss(ADNI) + labs(title = "Heatmap of Missing Values in ADNI Dataset")

# View all the rows with dataset = ABIL 
AIBL <- data[data$dataset == "AIBL", ]
View(AIBL)

gg_miss_var(AIBL) + ggtitle("Missing Values in Each Column of AIBL Dataset")
vis_miss(AIBL) + labs(title = "Heatmap of Missing Values in AIBL Dataset")

# View all the rows with dataset = UKBiobank 
UKB <- data[data$dataset == "UKB", ]
View(UKB)

gg_miss_var(UKB) + ggtitle("Missing Values in Each Column of UKB Dataset")
vis_miss(UKB) + labs(title = "Heatmap of Missing Values in UKB Dataset")

# View all the rows with conv = 0 
nonconvertors <- data[data$conv == 0, ]
View(nonconvertors)

gg_miss_var(nonconvertors) + ggtitle("Missing Values in Each Column of nonconvertors Dataset")
vis_miss(nonconvertors) + labs(title = "Heatmap of Missing Values in nonconvertors Dataset")

# View all the rows with conv = 1 
convertors <- data[data$conv == 1, ]
View(convertors)

gg_miss_var(convertors) + ggtitle("Missing Values in Each Column of convertors Dataset")
vis_miss(convertors) + labs(title = "Heatmap of Missing Values in convertors Dataset")
```

```{r}

# get rid of the columns FH_na and conv_fh???
```

## Regression analysis using the SNP FILE

install relevant packages:

```{r}

install.packages("pbapply")
library(pbapply)

install.packages("ggplot2")
library(ggplot2)

install.packages("GGally")
library(GGally)
```

```{r}
geno_covar <- readRDS("ukb_adni_genotypes_58_snps_v2.RDS")
View(geno_covar)


print(geno_covar[geno_covar$FID == 1000015, ])

# column/variable names
names(geno_covar)

print(data[data$ID == 1000015, ])

```

```{r}
computeSumStats <- function(yp, geno_covar) {
  # Identify columns starting with 'rs'
  rss = colnames(geno_covar)[grepl('^rs', colnames(geno_covar))]
  
  # Compute linear model summary statistics for each SNP
  sumstats = pbsapply(rss, \(rs) {
    # Subset data to include the current SNP, covariates, and remove geno_batch
    data_subset <- geno_covar %>%
      select(all_of(rs), -geno_batch, -one_of(setdiff(rss, rs)))
    
    # Combine yp and data_subset, remove rows with any NAs
    data_for_model <- data.frame(yp = yp, data_subset) %>%
      na.omit()
    
    # Fit the linear model with yp as the dependent variable
    m <- lm(yp ~ ., data = data_for_model)
    
    # Extract coefficients and filter for the SNP row
    summary(m) %>%
      coef() %>%
      as.data.frame() %>%
      filter(grepl("^rs", rownames(.)))
    
  }, simplify = F, USE.NAMES = T) %>%
    bind_rows() %>%
    magrittr::set_colnames(c('Est', 'SE', 't', 'P')) %>%
    rownames_to_column('rs')
}

# Test the function
result <- computeSumStats(yp, geno_covar)
print(result)



```

I have used the compute sumstats function to run a linear regression model for each snp against all the other covariates preset in the snp (geno_covar file), and the ouput is a dataframe containing the estimated coefficients (`Est`), standard errors (`SE`), t-values (`t`), and p-values (`P`) for each SNP.

I've plotted these statistics against each other to identify patterns using the following **Scatter Plots:**

-   **Estimates vs. P-values**: This plot helps identify SNPs with strong effects and significant associations.

-   **Estimates vs. Standard Errors**: This can show the precision of the estimates.

-   **t-values vs. P-values**: To see the relationship between the strength of association and statistical significance.

```{r}

# Scatter plot of Estimates vs P-values
ggplot(result, aes(x = Est, y = -log10(P))) +
  geom_point() +
  labs(title = "Effect Size vs. Significance",
       x = "Effect Size (Estimates)",
       y = "-log10(P-value)") +
  theme_minimal()

# Scatter plot of Estimates vs Standard Errors
ggplot(result, aes(x = Est, y = SE)) +
  geom_point() +
  labs(title = "Effect Size vs. Standard Errors",
       x = "Effect Size (Estimates)",
       y = "Standard Error") +
  theme_minimal()

# Scatter plot of t-values vs P-values
ggplot(result, aes(x = t, y = -log10(P))) +
  geom_point() +
  labs(title = "t-value vs. Significance",
       x = "t-value",
       y = "-log10(P-value)") +
  theme_minimal()

```

### **Scatter Plot of Estimates vs. -log10(P-values)**

-   This plot compares the effect sizes (estimates) of the SNPs to the significance of the association, where the p-values are transformed using `-log10`. A higher `-log10(P-value)` indicates a smaller p-value, which means more statistical significance.

-   **Interpretation**:

    -   **High -log10(P-value)**: Indicates that the SNP is statistically significant. These are the SNPs with the smallest p-values.

    -   **Low -log10(P-value)**: Indicates a less significant association. These are SNPs with larger p-values.

    -   **Large Estimate & High -log10(P-value)**: SNPs in this region have a strong effect and are highly significant, suggesting a robust association with the outcome.

    -   **Small Estimate & High -log10(P-value)**: SNPs with small effect sizes but significant p-values may be significant due to large sample sizes or subtle but real effects.

    -   **Scatter Pattern**: If there's a clear trend or relationship between effect size and significance (e.g., larger effect sizes consistently result in smaller p-values), this can suggest that your proxy labels are effectively capturing real genetic associations.

### **Scatter Plot of Estimates vs. Standard Errors**

-   This plot shows the relationship between the effect size estimates and their precision (standard errors).

-   **Interpretation**:

    -   **Large effect size & Small standard error**: These are robust associations; the SNP effect is strong and well-estimated.

    -   **Large effect size & Large standard error**: Suggests that the SNP might have a large effect, but it is less precise, possibly due to small sample size or high variability.

    -   **Small effect size & Small standard error**: Likely represents SNPs with no significant effect but precise estimates.

    -   **Small effect size & Large standard error**: Likely uninformative SNPs, with low effect and high uncertainty.

### **Scatter Plot of t-values vs. -log10(P-values)**

-   This plot compares the t-values (which measure the strength of the association) with the transformed p-values (`-log10(P-value)`).

-   **Interpretation**:

    -   **High t-value & High -log10(P-value)**: Indicates a strong association that is statistically significant.

    -   **Low t-value & Low -log10(P-value)**: Indicates weak or non-significant associations.

    -   **Clusters**: If most points cluster in the high t-value and high -log10(P-value) region, this suggests a group of SNPs with strong and significant effects.

    -   **Outliers**: SNPs that deviate from the main cluster, especially if they have high t-values but low significance (low -log10(P-value)), might be interesting to explore further, as they could indicate unusual effects or potential errors

#### **I've also made a Pairwise Comparison Plot as it** allows me to see relationships between all the statistical results for each SNP in a matrix of scatter plots.

```{r}

# Pairwise comparison plot
ggpairs(result, columns = c("Est", "SE", "t", "P"),
        title = "Pairwise Comparison of SNP Statistics")

# note you need GGally package for the ggpairs function - it extends the ggplot2 package in R.
```

-   **Diagonal plots**: Show the distribution of each statistic (e.g., histograms).

    -   **Off-diagonal scatter plots**: Show the relationships between pairs of statistics.

        -   **Correlations**: A linear pattern suggests a strong relationship between the statistics.

        -   **Clusters**: Groups of SNPs clustering together might indicate similar behavior across statistics.

        -   **Outliers**: Points far from the rest could indicate interesting SNPs for further investigation

```{r}
# Perform PCA
pca_result <- prcomp(result %>% select(Est, SE, t, P), scale. = TRUE)

# Extract PCA results
pca_data <- as.data.frame(pca_result$x)
pca_data$rs <- result$rs  # Add SNP names to the data

# Plot the first two principal components
library(ggplot2)
ggplot(pca_data, aes(x = PC1, y = PC2, label = rs)) +
  geom_point() +
  geom_text(vjust = -0.5, hjust = 0.5, size = 3) +
  labs(title = "PCA of SNP Statistics",
       x = "Principal Component 1",
       y = "Principal Component 2") +
  theme_minimal()

```

### this pca plot reduces the dimensionality of our data and shows how SNPs cluster based on their combined statistics.

-   

    -   **Clusters of SNPs**: SNPs that cluster together may have similar effects across all the statistics.

    -   **Outliers in PCA space**: SNPs that don't cluster with others may have unique effects and could be particularly interesting.

# **snp rs2075650 -** Located close to [ApoE4](https://www.snpedia.com/index.php/ApoE4 "ApoE4"), yet may independently (also) influence risk of [Alzheimer's disease](https://www.snpedia.com/index.php/Alzheimer%27s_disease "Alzheimer's disease").

-------------week 7---------

```{r}

# Assuming your datasets are named 'data' and 'geno_covar'

# First, rename the 'ID' column in the data dataset to 'FID' to match the geno_covar dataset
data$FID <- data$ID

# Merge keeping only rows with matching FID/ID
merged_data <- merge(geno_covar, data, by = "FID")

names(merged_data)



# Filter rows where FH.x and FH.y are not the same
different_rows <- merged_data[merged_data$SEX.x != merged_data$SEX.y, ]
different_rows

# Filter rows where FH.x and FH.y are not the same
different_rows <- merged_data[merged_data$conv.x != merged_data$conv.y, ]
different_rows

# DELETE THE UNUSEFUL COLUMNS
# Load dplyr if you haven't already
library(dplyr)

# Example: Remove specific columns using dplyr
merged_data <- merged_data %>% select(-FH.x, -AGE.x, -Assess_center, -geno_batch, - APOE4.x, APOE4_e4e4, -SEX.x, -FH_na.x, -ID, -FH_na.x)

merged_data <- merged_data %>% select(-conv.x)

View(merged_data)
```

```{r}
View(data)
```
